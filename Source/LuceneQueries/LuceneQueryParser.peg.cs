// -----------------------------------------------------------------------
// <auto-generated>
//   This code was generated by Pegasus 3.1.2.0
//
//   Changes to this file may cause incorrect behavior and will be lost if
//   the code is regenerated.
// </auto-generated>
// -----------------------------------------------------------------------

namespace
#line 1 "LuceneQueryParser.peg"
            Foundatio.Parsers.LuceneQueries
#line default
{
    using System;
    using System.Collections.Generic;
    using Pegasus.Common;
    using
        #line 3 "LuceneQueryParser.peg"
       System.Linq
        #line default
        ;
    using
        #line 4 "LuceneQueryParser.peg"
       Foundatio.Parsers.LuceneQueries.Nodes
        #line default
        ;
    using
        #line 5 "LuceneQueryParser.peg"
       Foundatio.Parsers.LuceneQueries.Extensions
        #line default
        ;

    /// <summary>
    ///  Parses a string according to the rules of the <see cref="LuceneQueryParser" /> grammar.
    /// </summary>
    [System.CodeDom.Compiler.GeneratedCode("Pegasus", "3.1.2.0")]
    public
    partial class
    #line 2 "LuceneQueryParser.peg"
           LuceneQueryParser
    #line default
    {
        #line 8 "LuceneQueryParser.peg"
 
    public class FieldInfo {
        public string Field { get; set; }
        public string Prefix { get; set; }
    }
        #line default

        /// <summary>
        ///  Parses a string according to the rules of the <see cref="LuceneQueryParser" /> grammar.
        /// </summary>
        /// <param name="subject">The parsing subject.</param>
        /// <param name="fileName">The optional file name to use in error messages.</param>
        /// <returns>The <see cref="GroupNode" /> parsed from <paramref name="subject" />.</returns>
        /// <exception cref="FormatException">
        ///  Thrown when parsing fails against <paramref name="subject"/>.  The exception's <code>Data["cursor"]</code> will be set with the cursor where the fatal error occurred.
        /// </exception>
        public GroupNode Parse(string subject, string fileName = null)
        {
            IList<LexicalElement> lexicalElements;
            return this.Parse(subject, fileName, out lexicalElements);
        }

        /// <summary>
        ///  Parses a string according to the rules of the <see cref="LuceneQueryParser" /> grammar.
        /// </summary>
        /// <param name="subject">The parsing subject.</param>
        /// <param name="fileName">The optional file name to use in error messages.</param>
        /// <param name="lexicalElements">When this method returns, contains the lexical elements for the parsing subject. This parameter is passed uninitialized.</param>
        /// <returns>The <see cref="GroupNode" /> parsed from <paramref name="subject" />.</returns>
        /// <exception cref="FormatException">
        ///  Thrown when parsing fails against <paramref name="subject"/>.  The exception's <code>Data["cursor"]</code> will be set with the cursor where the fatal error occurred.
        /// </exception>
        public GroupNode Parse(string subject, string fileName, out IList<LexicalElement> lexicalElements)
        {
            var cursor = new Cursor(subject, 0, fileName);
            var result = this.start(ref cursor);
            if (result == null)
            {
                throw ExceptionHelper(cursor, state => "Failed to parse 'start'.");
            }
            var lexical = (cursor["_lexical"] as ListNode<LexicalElement>).ToList();
            lexical.Reverse();
            lexicalElements = lexical.AsReadOnly();
            return result.Value;
        }

        private IParseResult<
            #line 15 "LuceneQueryParser.peg"
      GroupNode
            #line default
            > start(ref Cursor cursor)
        {
            IParseResult<GroupNode> r0 = null;
            if (r0 == null)
            {
                var startCursor0 = cursor;
                IParseResult<IList<IList<string>>> r1 = null;
                var startCursor1 = cursor;
                var l0 = new List<IList<string>>();
                while (true)
                {
                    IParseResult<IList<string>> r2 = null;
                    r2 = this._(ref cursor);
                    if (r2 != null)
                    {
                        l0.Add(r2.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r1 = this.ReturnHelper<IList<IList<string>>>(startCursor1, ref cursor, state => l0.AsReadOnly());
                if (r1 != null)
                {
                    IParseResult<IList<GroupNode>> r3 = null;
                    var nodeStart = cursor;
                    var startCursor2 = cursor;
                    var l1 = new List<GroupNode>();
                    while (l1.Count < 1)
                    {
                        IParseResult<GroupNode> r4 = null;
                        r4 = this.node(ref cursor);
                        if (r4 != null)
                        {
                            l1.Add(r4.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r3 = this.ReturnHelper<IList<GroupNode>>(startCursor2, ref cursor, state => l1.AsReadOnly());
                    var nodeEnd = cursor;
                    var node = ValueOrDefault(r3);
                    if (r3 != null)
                    {
                        IParseResult<IList<IList<string>>> r5 = null;
                        var startCursor3 = cursor;
                        var l2 = new List<IList<string>>();
                        while (true)
                        {
                            IParseResult<IList<string>> r6 = null;
                            r6 = this._(ref cursor);
                            if (r6 != null)
                            {
                                l2.Add(r6.Value);
                            }
                            else
                            {
                                break;
                            }
                        }
                        r5 = this.ReturnHelper<IList<IList<string>>>(startCursor3, ref cursor, state => l2.AsReadOnly());
                        if (r5 != null)
                        {
                            IParseResult<string> r7 = null;
                            r7 = this.EOF(ref cursor);
                            if (r7 != null)
                            {
                                r0 = this.ReturnHelper<GroupNode>(startCursor0, ref cursor, state =>
                                    #line 17 "LuceneQueryParser.peg"
     
        node.SingleOrDefault() ?? new GroupNode()
                                    #line default
                                    );
                            }
                            else
                            {
                                cursor = startCursor0;
                            }
                        }
                        else
                        {
                            cursor = startCursor0;
                        }
                    }
                    else
                    {
                        cursor = startCursor0;
                    }
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            if (r0 == null)
            {
                var startCursor4 = cursor;
                throw this.ExceptionHelper(startCursor4, state =>
                    #line 20 "LuceneQueryParser.peg"
            "Unable to parse query."
                    #line default
                    );
            }
            return r0;
        }

        private IParseResult<
            #line 22 "LuceneQueryParser.peg"
     GroupNode
            #line default
            > node(ref Cursor cursor)
        {
            IParseResult<GroupNode> r0 = null;
            if (r0 == null)
            {
                var startCursor0 = cursor;
                IParseResult<GroupOperator> r1 = null;
                var opStart = cursor;
                r1 = this.operator_exp(ref cursor);
                var opEnd = cursor;
                var op = ValueOrDefault(r1);
                if (r1 != null)
                {
                    IParseResult<string> r2 = null;
                    r2 = this.EOF(ref cursor);
                    if (r2 != null)
                    {
                        r0 = this.ReturnHelper<GroupNode>(startCursor0, ref cursor, state =>
                            #line 24 "LuceneQueryParser.peg"
     
        new GroupNode {
            Operator = op
        }
                            #line default
                            );
                    }
                    else
                    {
                        cursor = startCursor0;
                    }
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            if (r0 == null)
            {
                var startCursor1 = cursor;
                IParseResult<GroupOperator> r3 = null;
                var opStart = cursor;
                r3 = this.operator_exp(ref cursor);
                var opEnd = cursor;
                var op = ValueOrDefault(r3);
                if (r3 != null)
                {
                    IParseResult<GroupNode> r4 = null;
                    var rightStart = cursor;
                    r4 = this.node(ref cursor);
                    var rightEnd = cursor;
                    var right = ValueOrDefault(r4);
                    if (r4 != null)
                    {
                        r0 = this.ReturnHelper<GroupNode>(startCursor1, ref cursor, state =>
                            #line 30 "LuceneQueryParser.peg"
     
        right
                            #line default
                            );
                    }
                    else
                    {
                        cursor = startCursor1;
                    }
                }
                else
                {
                    cursor = startCursor1;
                }
            }
            if (r0 == null)
            {
                var startCursor2 = cursor;
                IParseResult<IQueryNode> r5 = null;
                var leftStart = cursor;
                r5 = this.group_exp(ref cursor);
                var leftEnd = cursor;
                var left = ValueOrDefault(r5);
                if (r5 != null)
                {
                    IParseResult<IList<GroupOperator>> r6 = null;
                    var opStart = cursor;
                    var startCursor3 = cursor;
                    var l0 = new List<GroupOperator>();
                    while (l0.Count < 1)
                    {
                        IParseResult<GroupOperator> r7 = null;
                        r7 = this.operator_exp(ref cursor);
                        if (r7 != null)
                        {
                            l0.Add(r7.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r6 = this.ReturnHelper<IList<GroupOperator>>(startCursor3, ref cursor, state => l0.AsReadOnly());
                    var opEnd = cursor;
                    var op = ValueOrDefault(r6);
                    if (r6 != null)
                    {
                        IParseResult<IList<GroupNode>> r8 = null;
                        var rightStart = cursor;
                        var startCursor4 = cursor;
                        var l1 = new List<GroupNode>();
                        while (true)
                        {
                            IParseResult<GroupNode> r9 = null;
                            r9 = this.node(ref cursor);
                            if (r9 != null)
                            {
                                l1.Add(r9.Value);
                            }
                            else
                            {
                                break;
                            }
                        }
                        r8 = this.ReturnHelper<IList<GroupNode>>(startCursor4, ref cursor, state => l1.AsReadOnly());
                        var rightEnd = cursor;
                        var right = ValueOrDefault(r8);
                        if (r8 != null)
                        {
                            r0 = this.ReturnHelper<GroupNode>(startCursor2, ref cursor, state =>
                                #line 34 "LuceneQueryParser.peg"
     {
        var node= new GroupNode {
            Left = left
        };
		left.Parent = node;

        var rightExp =
                right.Count == 0
                ? (TermNode)null
                : right[0].Right == null
                    ? right[0].Left
                    : right[0];

        if (rightExp != null)
        {
            node.Operator = op.SingleOrDefault();
            node.Right = rightExp;
			rightExp.Parent = node;
        }

        return node;
    }
                                #line default
                                );
                        }
                        else
                        {
                            cursor = startCursor2;
                        }
                    }
                    else
                    {
                        cursor = startCursor2;
                    }
                }
                else
                {
                    cursor = startCursor2;
                }
            }
            return r0;
        }

        private IParseResult<
            #line 57 "LuceneQueryParser.peg"
          IQueryNode
            #line default
            > group_exp(ref Cursor cursor)
        {
            IParseResult<IQueryNode> r0 = null;
            if (r0 == null)
            {
                var startCursor0 = cursor;
                IParseResult<IQueryNode> r1 = null;
                var field_expStart = cursor;
                r1 = this.field_exp(ref cursor);
                var field_expEnd = cursor;
                var field_exp = ValueOrDefault(r1);
                if (r1 != null)
                {
                    IParseResult<IList<IList<string>>> r2 = null;
                    var startCursor1 = cursor;
                    var l0 = new List<IList<string>>();
                    while (true)
                    {
                        IParseResult<IList<string>> r3 = null;
                        r3 = this._(ref cursor);
                        if (r3 != null)
                        {
                            l0.Add(r3.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r2 = this.ReturnHelper<IList<IList<string>>>(startCursor1, ref cursor, state => l0.AsReadOnly());
                    if (r2 != null)
                    {
                        r0 = this.ReturnHelper<IQueryNode>(startCursor0, ref cursor, state =>
                            #line 59 "LuceneQueryParser.peg"
     
        field_exp
                            #line default
                            );
                    }
                    else
                    {
                        cursor = startCursor0;
                    }
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            if (r0 == null)
            {
                r0 = this.paren_exp(ref cursor);
            }
            return r0;
        }

        private IParseResult<
            #line 64 "LuceneQueryParser.peg"
          GroupNode
            #line default
            > paren_exp(ref Cursor cursor)
        {
            IParseResult<GroupNode> r0 = null;
            var startCursor0 = cursor;
            IParseResult<string> r1 = null;
            r1 = this.ParseLiteral(ref cursor, "(");
            if (r1 != null)
            {
                IParseResult<GroupNode> r2 = null;
                var nodeStart = cursor;
                r2 = this.node(ref cursor);
                var nodeEnd = cursor;
                var node = ValueOrDefault(r2);
                if (r2 != null)
                {
                    IParseResult<string> r3 = null;
                    r3 = this.ParseLiteral(ref cursor, ")");
                    if (r3 != null)
                    {
                        IParseResult<IList<string>> r4 = null;
                        var boostStart = cursor;
                        var startCursor1 = cursor;
                        var l0 = new List<string>();
                        while (l0.Count < 1)
                        {
                            IParseResult<string> r5 = null;
                            r5 = this.boost_modifier(ref cursor);
                            if (r5 != null)
                            {
                                l0.Add(r5.Value);
                            }
                            else
                            {
                                break;
                            }
                        }
                        r4 = this.ReturnHelper<IList<string>>(startCursor1, ref cursor, state => l0.AsReadOnly());
                        var boostEnd = cursor;
                        var boost = ValueOrDefault(r4);
                        if (r4 != null)
                        {
                            IParseResult<IList<IList<string>>> r6 = null;
                            var startCursor2 = cursor;
                            var l1 = new List<IList<string>>();
                            while (true)
                            {
                                IParseResult<IList<string>> r7 = null;
                                r7 = this._(ref cursor);
                                if (r7 != null)
                                {
                                    l1.Add(r7.Value);
                                }
                                else
                                {
                                    break;
                                }
                            }
                            r6 = this.ReturnHelper<IList<IList<string>>>(startCursor2, ref cursor, state => l1.AsReadOnly());
                            if (r6 != null)
                            {
                                r0 = this.ReturnHelper<GroupNode>(startCursor0, ref cursor, state =>
                                    #line 66 "LuceneQueryParser.peg"
     {
        node.HasParens = true;

        if (boost.Count > 0)
            node.Boost = boost.SingleOrDefault();

        return node;
    }
                                    #line default
                                    );
                            }
                            else
                            {
                                cursor = startCursor0;
                            }
                        }
                        else
                        {
                            cursor = startCursor0;
                        }
                    }
                    else
                    {
                        cursor = startCursor0;
                    }
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            else
            {
                cursor = startCursor0;
            }
            return r0;
        }

        private IParseResult<
            #line 75 "LuceneQueryParser.peg"
          IQueryNode
            #line default
            > field_exp(ref Cursor cursor)
        {
            IParseResult<IQueryNode> r0 = null;
            if (r0 == null)
            {
                var startCursor0 = cursor;
                IParseResult<IList<string>> r1 = null;
                var notStart = cursor;
                var startCursor1 = cursor;
                var l0 = new List<string>();
                while (l0.Count < 1)
                {
                    IParseResult<string> r2 = null;
                    r2 = this.not_exp(ref cursor);
                    if (r2 != null)
                    {
                        l0.Add(r2.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r1 = this.ReturnHelper<IList<string>>(startCursor1, ref cursor, state => l0.AsReadOnly());
                var notEnd = cursor;
                var not = ValueOrDefault(r1);
                if (r1 != null)
                {
                    IParseResult<IList<string>> r3 = null;
                    var opStart = cursor;
                    var startCursor2 = cursor;
                    var l1 = new List<string>();
                    while (l1.Count < 1)
                    {
                        IParseResult<string> r4 = null;
                        r4 = this.prefix_operator_exp(ref cursor);
                        if (r4 != null)
                        {
                            l1.Add(r4.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r3 = this.ReturnHelper<IList<string>>(startCursor2, ref cursor, state => l1.AsReadOnly());
                    var opEnd = cursor;
                    var op = ValueOrDefault(r3);
                    if (r3 != null)
                    {
                        IParseResult<string> r5 = null;
                        r5 = this.ParseLiteral(ref cursor, "_exists_");
                        if (r5 != null)
                        {
                            IParseResult<IList<IList<string>>> r6 = null;
                            var startCursor3 = cursor;
                            var l2 = new List<IList<string>>();
                            while (true)
                            {
                                IParseResult<IList<string>> r7 = null;
                                r7 = this._(ref cursor);
                                if (r7 != null)
                                {
                                    l2.Add(r7.Value);
                                }
                                else
                                {
                                    break;
                                }
                            }
                            r6 = this.ReturnHelper<IList<IList<string>>>(startCursor3, ref cursor, state => l2.AsReadOnly());
                            if (r6 != null)
                            {
                                IParseResult<string> r8 = null;
                                r8 = this.ParseLiteral(ref cursor, ":");
                                if (r8 != null)
                                {
                                    IParseResult<IList<IList<string>>> r9 = null;
                                    var startCursor4 = cursor;
                                    var l3 = new List<IList<string>>();
                                    while (true)
                                    {
                                        IParseResult<IList<string>> r10 = null;
                                        r10 = this._(ref cursor);
                                        if (r10 != null)
                                        {
                                            l3.Add(r10.Value);
                                        }
                                        else
                                        {
                                            break;
                                        }
                                    }
                                    r9 = this.ReturnHelper<IList<IList<string>>>(startCursor4, ref cursor, state => l3.AsReadOnly());
                                    if (r9 != null)
                                    {
                                        IParseResult<string> r11 = null;
                                        var fieldnameStart = cursor;
                                        r11 = this.name_term(ref cursor);
                                        var fieldnameEnd = cursor;
                                        var fieldname = ValueOrDefault(r11);
                                        if (r11 != null)
                                        {
                                            r0 = this.ReturnHelper<IQueryNode>(startCursor0, ref cursor, state =>
                                                #line 77 "LuceneQueryParser.peg"
   {
        return new ExistsNode { IsNegated = not.Any(), Prefix = op.SingleOrDefault(), Field = fieldname };
  }
                                                #line default
                                                );
                                        }
                                        else
                                        {
                                            cursor = startCursor0;
                                        }
                                    }
                                    else
                                    {
                                        cursor = startCursor0;
                                    }
                                }
                                else
                                {
                                    cursor = startCursor0;
                                }
                            }
                            else
                            {
                                cursor = startCursor0;
                            }
                        }
                        else
                        {
                            cursor = startCursor0;
                        }
                    }
                    else
                    {
                        cursor = startCursor0;
                    }
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            if (r0 == null)
            {
                var startCursor5 = cursor;
                IParseResult<IList<string>> r12 = null;
                var notStart = cursor;
                var startCursor6 = cursor;
                var l4 = new List<string>();
                while (l4.Count < 1)
                {
                    IParseResult<string> r13 = null;
                    r13 = this.not_exp(ref cursor);
                    if (r13 != null)
                    {
                        l4.Add(r13.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r12 = this.ReturnHelper<IList<string>>(startCursor6, ref cursor, state => l4.AsReadOnly());
                var notEnd = cursor;
                var not = ValueOrDefault(r12);
                if (r12 != null)
                {
                    IParseResult<IList<string>> r14 = null;
                    var opStart = cursor;
                    var startCursor7 = cursor;
                    var l5 = new List<string>();
                    while (l5.Count < 1)
                    {
                        IParseResult<string> r15 = null;
                        r15 = this.prefix_operator_exp(ref cursor);
                        if (r15 != null)
                        {
                            l5.Add(r15.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r14 = this.ReturnHelper<IList<string>>(startCursor7, ref cursor, state => l5.AsReadOnly());
                    var opEnd = cursor;
                    var op = ValueOrDefault(r14);
                    if (r14 != null)
                    {
                        IParseResult<string> r16 = null;
                        r16 = this.ParseLiteral(ref cursor, "_missing_");
                        if (r16 != null)
                        {
                            IParseResult<IList<IList<string>>> r17 = null;
                            var startCursor8 = cursor;
                            var l6 = new List<IList<string>>();
                            while (true)
                            {
                                IParseResult<IList<string>> r18 = null;
                                r18 = this._(ref cursor);
                                if (r18 != null)
                                {
                                    l6.Add(r18.Value);
                                }
                                else
                                {
                                    break;
                                }
                            }
                            r17 = this.ReturnHelper<IList<IList<string>>>(startCursor8, ref cursor, state => l6.AsReadOnly());
                            if (r17 != null)
                            {
                                IParseResult<string> r19 = null;
                                r19 = this.ParseLiteral(ref cursor, ":");
                                if (r19 != null)
                                {
                                    IParseResult<IList<IList<string>>> r20 = null;
                                    var startCursor9 = cursor;
                                    var l7 = new List<IList<string>>();
                                    while (true)
                                    {
                                        IParseResult<IList<string>> r21 = null;
                                        r21 = this._(ref cursor);
                                        if (r21 != null)
                                        {
                                            l7.Add(r21.Value);
                                        }
                                        else
                                        {
                                            break;
                                        }
                                    }
                                    r20 = this.ReturnHelper<IList<IList<string>>>(startCursor9, ref cursor, state => l7.AsReadOnly());
                                    if (r20 != null)
                                    {
                                        IParseResult<string> r22 = null;
                                        var fieldnameStart = cursor;
                                        r22 = this.name_term(ref cursor);
                                        var fieldnameEnd = cursor;
                                        var fieldname = ValueOrDefault(r22);
                                        if (r22 != null)
                                        {
                                            r0 = this.ReturnHelper<IQueryNode>(startCursor5, ref cursor, state =>
                                                #line 81 "LuceneQueryParser.peg"
   {
        return new MissingNode { IsNegated = not.Any(), Prefix = op.SingleOrDefault(), Field = fieldname };
  }
                                                #line default
                                                );
                                        }
                                        else
                                        {
                                            cursor = startCursor5;
                                        }
                                    }
                                    else
                                    {
                                        cursor = startCursor5;
                                    }
                                }
                                else
                                {
                                    cursor = startCursor5;
                                }
                            }
                            else
                            {
                                cursor = startCursor5;
                            }
                        }
                        else
                        {
                            cursor = startCursor5;
                        }
                    }
                    else
                    {
                        cursor = startCursor5;
                    }
                }
                else
                {
                    cursor = startCursor5;
                }
            }
            if (r0 == null)
            {
                var startCursor10 = cursor;
                IParseResult<IList<string>> r23 = null;
                var notStart = cursor;
                var startCursor11 = cursor;
                var l8 = new List<string>();
                while (l8.Count < 1)
                {
                    IParseResult<string> r24 = null;
                    r24 = this.not_exp(ref cursor);
                    if (r24 != null)
                    {
                        l8.Add(r24.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r23 = this.ReturnHelper<IList<string>>(startCursor11, ref cursor, state => l8.AsReadOnly());
                var notEnd = cursor;
                var not = ValueOrDefault(r23);
                if (r23 != null)
                {
                    IParseResult<IList<FieldInfo>> r25 = null;
                    var nameStart = cursor;
                    var startCursor12 = cursor;
                    var l9 = new List<FieldInfo>();
                    while (l9.Count < 1)
                    {
                        IParseResult<FieldInfo> r26 = null;
                        r26 = this.fieldname(ref cursor);
                        if (r26 != null)
                        {
                            l9.Add(r26.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r25 = this.ReturnHelper<IList<FieldInfo>>(startCursor12, ref cursor, state => l9.AsReadOnly());
                    var nameEnd = cursor;
                    var name = ValueOrDefault(r25);
                    if (r25 != null)
                    {
                        IParseResult<TermRangeNode> r27 = null;
                        var rangeStart = cursor;
                        r27 = this.range_operator_exp(ref cursor);
                        var rangeEnd = cursor;
                        var range = ValueOrDefault(r27);
                        if (r27 != null)
                        {
                            r0 = this.ReturnHelper<IQueryNode>(startCursor10, ref cursor, state =>
                                #line 85 "LuceneQueryParser.peg"
     {
        if (name.Count == 1) {
		  range.IsNegated = not.Any();
          range.Field = name[0].Field;
          range.Prefix = name[0].Prefix;
        }

        return range;
    }
                                #line default
                                );
                        }
                        else
                        {
                            cursor = startCursor10;
                        }
                    }
                    else
                    {
                        cursor = startCursor10;
                    }
                }
                else
                {
                    cursor = startCursor10;
                }
            }
            if (r0 == null)
            {
                var startCursor13 = cursor;
                IParseResult<IList<string>> r28 = null;
                var notStart = cursor;
                var startCursor14 = cursor;
                var l10 = new List<string>();
                while (l10.Count < 1)
                {
                    IParseResult<string> r29 = null;
                    r29 = this.not_exp(ref cursor);
                    if (r29 != null)
                    {
                        l10.Add(r29.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r28 = this.ReturnHelper<IList<string>>(startCursor14, ref cursor, state => l10.AsReadOnly());
                var notEnd = cursor;
                var not = ValueOrDefault(r28);
                if (r28 != null)
                {
                    IParseResult<IList<string>> r30 = null;
                    var opStart = cursor;
                    var startCursor15 = cursor;
                    var l11 = new List<string>();
                    while (l11.Count < 1)
                    {
                        IParseResult<string> r31 = null;
                        r31 = this.prefix_operator_exp(ref cursor);
                        if (r31 != null)
                        {
                            l11.Add(r31.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r30 = this.ReturnHelper<IList<string>>(startCursor15, ref cursor, state => l11.AsReadOnly());
                    var opEnd = cursor;
                    var op = ValueOrDefault(r30);
                    if (r30 != null)
                    {
                        IParseResult<TermRangeNode> r32 = null;
                        var rangeStart = cursor;
                        r32 = this.range_operator_exp(ref cursor);
                        var rangeEnd = cursor;
                        var range = ValueOrDefault(r32);
                        if (r32 != null)
                        {
                            r0 = this.ReturnHelper<IQueryNode>(startCursor13, ref cursor, state =>
                                #line 95 "LuceneQueryParser.peg"
     {
		range.IsNegated = not.Any();
        range.Prefix = op.SingleOrDefault();
        return range;
    }
                                #line default
                                );
                        }
                        else
                        {
                            cursor = startCursor13;
                        }
                    }
                    else
                    {
                        cursor = startCursor13;
                    }
                }
                else
                {
                    cursor = startCursor13;
                }
            }
            if (r0 == null)
            {
                var startCursor16 = cursor;
                IParseResult<IList<string>> r33 = null;
                var notStart = cursor;
                var startCursor17 = cursor;
                var l12 = new List<string>();
                while (l12.Count < 1)
                {
                    IParseResult<string> r34 = null;
                    r34 = this.not_exp(ref cursor);
                    if (r34 != null)
                    {
                        l12.Add(r34.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r33 = this.ReturnHelper<IList<string>>(startCursor17, ref cursor, state => l12.AsReadOnly());
                var notEnd = cursor;
                var not = ValueOrDefault(r33);
                if (r33 != null)
                {
                    IParseResult<FieldInfo> r35 = null;
                    var nameStart = cursor;
                    r35 = this.fieldname(ref cursor);
                    var nameEnd = cursor;
                    var name = ValueOrDefault(r35);
                    if (r35 != null)
                    {
                        IParseResult<GroupNode> r36 = null;
                        var nodeStart = cursor;
                        r36 = this.paren_exp(ref cursor);
                        var nodeEnd = cursor;
                        var node = ValueOrDefault(r36);
                        if (r36 != null)
                        {
                            r0 = this.ReturnHelper<IQueryNode>(startCursor16, ref cursor, state =>
                                #line 101 "LuceneQueryParser.peg"
     {
		node.IsNegated = not.Any();
        node.Field = name.Field;
        node.Prefix = name.Prefix;
        return node;
    }
                                #line default
                                );
                        }
                        else
                        {
                            cursor = startCursor16;
                        }
                    }
                    else
                    {
                        cursor = startCursor16;
                    }
                }
                else
                {
                    cursor = startCursor16;
                }
            }
            if (r0 == null)
            {
                var startCursor18 = cursor;
                IParseResult<IList<string>> r37 = null;
                var notStart = cursor;
                var startCursor19 = cursor;
                var l13 = new List<string>();
                while (l13.Count < 1)
                {
                    IParseResult<string> r38 = null;
                    r38 = this.not_exp(ref cursor);
                    if (r38 != null)
                    {
                        l13.Add(r38.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r37 = this.ReturnHelper<IList<string>>(startCursor19, ref cursor, state => l13.AsReadOnly());
                var notEnd = cursor;
                var not = ValueOrDefault(r37);
                if (r37 != null)
                {
                    IParseResult<IList<FieldInfo>> r39 = null;
                    var nameStart = cursor;
                    var startCursor20 = cursor;
                    var l14 = new List<FieldInfo>();
                    while (l14.Count < 1)
                    {
                        IParseResult<FieldInfo> r40 = null;
                        r40 = this.fieldname(ref cursor);
                        if (r40 != null)
                        {
                            l14.Add(r40.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r39 = this.ReturnHelper<IList<FieldInfo>>(startCursor20, ref cursor, state => l14.AsReadOnly());
                    var nameEnd = cursor;
                    var name = ValueOrDefault(r39);
                    if (r39 != null)
                    {
                        IParseResult<TermNode> r41 = null;
                        var termStart = cursor;
                        r41 = this.term(ref cursor);
                        var termEnd = cursor;
                        var term = ValueOrDefault(r41);
                        if (r41 != null)
                        {
                            r0 = this.ReturnHelper<IQueryNode>(startCursor18, ref cursor, state =>
                                #line 108 "LuceneQueryParser.peg"
     {
        var query = new TermNode();

		if (not.Any())
			query.IsNegated = true;

        if (name.Count == 1) {
          query.Field = name[0].Field;
          query.Prefix = name[0].Prefix;
        }

        term.CopyTo(query);

        return query;
    }
                                #line default
                                );
                        }
                        else
                        {
                            cursor = startCursor18;
                        }
                    }
                    else
                    {
                        cursor = startCursor18;
                    }
                }
                else
                {
                    cursor = startCursor18;
                }
            }
            return r0;
        }

        private IParseResult<
            #line 124 "LuceneQueryParser.peg"
          FieldInfo
            #line default
            > fieldname(ref Cursor cursor)
        {
            IParseResult<FieldInfo> r0 = null;
            var startCursor0 = cursor;
            IParseResult<IList<string>> r1 = null;
            var opStart = cursor;
            var startCursor1 = cursor;
            var l0 = new List<string>();
            while (l0.Count < 1)
            {
                IParseResult<string> r2 = null;
                r2 = this.prefix_operator_exp(ref cursor);
                if (r2 != null)
                {
                    l0.Add(r2.Value);
                }
                else
                {
                    break;
                }
            }
            r1 = this.ReturnHelper<IList<string>>(startCursor1, ref cursor, state => l0.AsReadOnly());
            var opEnd = cursor;
            var op = ValueOrDefault(r1);
            if (r1 != null)
            {
                IParseResult<string> r3 = null;
                var fieldnameStart = cursor;
                r3 = this.name_term(ref cursor);
                var fieldnameEnd = cursor;
                var fieldname = ValueOrDefault(r3);
                if (r3 != null)
                {
                    IParseResult<IList<IList<string>>> r4 = null;
                    var startCursor2 = cursor;
                    var l1 = new List<IList<string>>();
                    while (true)
                    {
                        IParseResult<IList<string>> r5 = null;
                        r5 = this._(ref cursor);
                        if (r5 != null)
                        {
                            l1.Add(r5.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r4 = this.ReturnHelper<IList<IList<string>>>(startCursor2, ref cursor, state => l1.AsReadOnly());
                    if (r4 != null)
                    {
                        IParseResult<string> r6 = null;
                        r6 = this.ParseLiteral(ref cursor, ":");
                        if (r6 != null)
                        {
                            IParseResult<IList<IList<string>>> r7 = null;
                            var startCursor3 = cursor;
                            var l2 = new List<IList<string>>();
                            while (true)
                            {
                                IParseResult<IList<string>> r8 = null;
                                r8 = this._(ref cursor);
                                if (r8 != null)
                                {
                                    l2.Add(r8.Value);
                                }
                                else
                                {
                                    break;
                                }
                            }
                            r7 = this.ReturnHelper<IList<IList<string>>>(startCursor3, ref cursor, state => l2.AsReadOnly());
                            if (r7 != null)
                            {
                                r0 = this.ReturnHelper<FieldInfo>(startCursor0, ref cursor, state =>
                                    #line 126 "LuceneQueryParser.peg"
       {
        var result = new FieldInfo { Field = fieldname };

        result.Prefix = op.SingleOrDefault();

        return result;
    }
                                    #line default
                                    , ruleName: "fieldname");
                            }
                            else
                            {
                                cursor = startCursor0;
                            }
                        }
                        else
                        {
                            cursor = startCursor0;
                        }
                    }
                    else
                    {
                        cursor = startCursor0;
                    }
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            else
            {
                cursor = startCursor0;
            }
            return r0;
        }

        private IParseResult<
            #line 134 "LuceneQueryParser.peg"
     TermNode
            #line default
            > term(ref Cursor cursor)
        {
            IParseResult<TermNode> r0 = null;
            if (r0 == null)
            {
                var startCursor0 = cursor;
                IParseResult<IList<string>> r1 = null;
                var notStart = cursor;
                var startCursor1 = cursor;
                var l0 = new List<string>();
                while (l0.Count < 1)
                {
                    IParseResult<string> r2 = null;
                    r2 = this.not_exp(ref cursor);
                    if (r2 != null)
                    {
                        l0.Add(r2.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r1 = this.ReturnHelper<IList<string>>(startCursor1, ref cursor, state => l0.AsReadOnly());
                var notEnd = cursor;
                var not = ValueOrDefault(r1);
                if (r1 != null)
                {
                    IParseResult<IList<string>> r3 = null;
                    var opStart = cursor;
                    var startCursor2 = cursor;
                    var l1 = new List<string>();
                    while (l1.Count < 1)
                    {
                        IParseResult<string> r4 = null;
                        r4 = this.prefix_operator_exp(ref cursor);
                        if (r4 != null)
                        {
                            l1.Add(r4.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r3 = this.ReturnHelper<IList<string>>(startCursor2, ref cursor, state => l1.AsReadOnly());
                    var opEnd = cursor;
                    var op = ValueOrDefault(r3);
                    if (r3 != null)
                    {
                        IParseResult<string> r5 = null;
                        var termStart = cursor;
                        r5 = this.quoted_term(ref cursor);
                        var termEnd = cursor;
                        var term = ValueOrDefault(r5);
                        if (r5 != null)
                        {
                            IParseResult<IList<string>> r6 = null;
                            var proximityStart = cursor;
                            var startCursor3 = cursor;
                            var l2 = new List<string>();
                            while (l2.Count < 1)
                            {
                                IParseResult<string> r7 = null;
                                r7 = this.proximity_modifier(ref cursor);
                                if (r7 != null)
                                {
                                    l2.Add(r7.Value);
                                }
                                else
                                {
                                    break;
                                }
                            }
                            r6 = this.ReturnHelper<IList<string>>(startCursor3, ref cursor, state => l2.AsReadOnly());
                            var proximityEnd = cursor;
                            var proximity = ValueOrDefault(r6);
                            if (r6 != null)
                            {
                                IParseResult<IList<string>> r8 = null;
                                var boostStart = cursor;
                                var startCursor4 = cursor;
                                var l3 = new List<string>();
                                while (l3.Count < 1)
                                {
                                    IParseResult<string> r9 = null;
                                    r9 = this.boost_modifier(ref cursor);
                                    if (r9 != null)
                                    {
                                        l3.Add(r9.Value);
                                    }
                                    else
                                    {
                                        break;
                                    }
                                }
                                r8 = this.ReturnHelper<IList<string>>(startCursor4, ref cursor, state => l3.AsReadOnly());
                                var boostEnd = cursor;
                                var boost = ValueOrDefault(r8);
                                if (r8 != null)
                                {
                                    IParseResult<IList<IList<string>>> r10 = null;
                                    var startCursor5 = cursor;
                                    var l4 = new List<IList<string>>();
                                    while (true)
                                    {
                                        IParseResult<IList<string>> r11 = null;
                                        r11 = this._(ref cursor);
                                        if (r11 != null)
                                        {
                                            l4.Add(r11.Value);
                                        }
                                        else
                                        {
                                            break;
                                        }
                                    }
                                    r10 = this.ReturnHelper<IList<IList<string>>>(startCursor5, ref cursor, state => l4.AsReadOnly());
                                    if (r10 != null)
                                    {
                                        r0 = this.ReturnHelper<TermNode>(startCursor0, ref cursor, state =>
                                            #line 136 "LuceneQueryParser.peg"
       {
        var result = new TermNode { Term = term, IsQuotedTerm = true };

        if (proximity.Count > 0)
            result.Proximity = proximity.SingleOrDefault();

        if (boost.Count > 0)
            result.Boost = boost.SingleOrDefault();

		if (not.Any())
			result.IsNegated = true;
        result.Prefix = op.SingleOrDefault();

        return result;
    }
                                            #line default
                                            );
                                    }
                                    else
                                    {
                                        cursor = startCursor0;
                                    }
                                }
                                else
                                {
                                    cursor = startCursor0;
                                }
                            }
                            else
                            {
                                cursor = startCursor0;
                            }
                        }
                        else
                        {
                            cursor = startCursor0;
                        }
                    }
                    else
                    {
                        cursor = startCursor0;
                    }
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            if (r0 == null)
            {
                var startCursor6 = cursor;
                IParseResult<IList<string>> r12 = null;
                var notStart = cursor;
                var startCursor7 = cursor;
                var l5 = new List<string>();
                while (l5.Count < 1)
                {
                    IParseResult<string> r13 = null;
                    r13 = this.not_exp(ref cursor);
                    if (r13 != null)
                    {
                        l5.Add(r13.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r12 = this.ReturnHelper<IList<string>>(startCursor7, ref cursor, state => l5.AsReadOnly());
                var notEnd = cursor;
                var not = ValueOrDefault(r12);
                if (r12 != null)
                {
                    IParseResult<IList<string>> r14 = null;
                    var opStart = cursor;
                    var startCursor8 = cursor;
                    var l6 = new List<string>();
                    while (l6.Count < 1)
                    {
                        IParseResult<string> r15 = null;
                        r15 = this.prefix_operator_exp(ref cursor);
                        if (r15 != null)
                        {
                            l6.Add(r15.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r14 = this.ReturnHelper<IList<string>>(startCursor8, ref cursor, state => l6.AsReadOnly());
                    var opEnd = cursor;
                    var op = ValueOrDefault(r14);
                    if (r14 != null)
                    {
                        IParseResult<string> r16 = null;
                        var termStart = cursor;
                        r16 = this.unquoted_term(ref cursor);
                        var termEnd = cursor;
                        var term = ValueOrDefault(r16);
                        if (r16 != null)
                        {
                            IParseResult<IList<string>> r17 = null;
                            var proximityStart = cursor;
                            var startCursor9 = cursor;
                            var l7 = new List<string>();
                            while (l7.Count < 1)
                            {
                                IParseResult<string> r18 = null;
                                r18 = this.proximity_modifier(ref cursor);
                                if (r18 != null)
                                {
                                    l7.Add(r18.Value);
                                }
                                else
                                {
                                    break;
                                }
                            }
                            r17 = this.ReturnHelper<IList<string>>(startCursor9, ref cursor, state => l7.AsReadOnly());
                            var proximityEnd = cursor;
                            var proximity = ValueOrDefault(r17);
                            if (r17 != null)
                            {
                                IParseResult<IList<string>> r19 = null;
                                var boostStart = cursor;
                                var startCursor10 = cursor;
                                var l8 = new List<string>();
                                while (l8.Count < 1)
                                {
                                    IParseResult<string> r20 = null;
                                    r20 = this.boost_modifier(ref cursor);
                                    if (r20 != null)
                                    {
                                        l8.Add(r20.Value);
                                    }
                                    else
                                    {
                                        break;
                                    }
                                }
                                r19 = this.ReturnHelper<IList<string>>(startCursor10, ref cursor, state => l8.AsReadOnly());
                                var boostEnd = cursor;
                                var boost = ValueOrDefault(r19);
                                if (r19 != null)
                                {
                                    IParseResult<IList<IList<string>>> r21 = null;
                                    var startCursor11 = cursor;
                                    var l9 = new List<IList<string>>();
                                    while (true)
                                    {
                                        IParseResult<IList<string>> r22 = null;
                                        r22 = this._(ref cursor);
                                        if (r22 != null)
                                        {
                                            l9.Add(r22.Value);
                                        }
                                        else
                                        {
                                            break;
                                        }
                                    }
                                    r21 = this.ReturnHelper<IList<IList<string>>>(startCursor11, ref cursor, state => l9.AsReadOnly());
                                    if (r21 != null)
                                    {
                                        r0 = this.ReturnHelper<TermNode>(startCursor6, ref cursor, state =>
                                            #line 152 "LuceneQueryParser.peg"
     {
        var result = new TermNode { Term = term };

        if (proximity.Count > 0)
            result.Proximity = proximity.SingleOrDefault();

        if (boost.Count > 0)
            result.Boost = boost.SingleOrDefault();

		if (not.Any())
			result.IsNegated = true;
        result.Prefix = op.SingleOrDefault();

        return result;
    }
                                            #line default
                                            );
                                    }
                                    else
                                    {
                                        cursor = startCursor6;
                                    }
                                }
                                else
                                {
                                    cursor = startCursor6;
                                }
                            }
                            else
                            {
                                cursor = startCursor6;
                            }
                        }
                        else
                        {
                            cursor = startCursor6;
                        }
                    }
                    else
                    {
                        cursor = startCursor6;
                    }
                }
                else
                {
                    cursor = startCursor6;
                }
            }
            return r0;
        }

        private IParseResult<string> name_term(ref Cursor cursor)
        {
            IParseResult<string> r0 = null;
            var startCursor0 = cursor;
            IParseResult<string> r1 = null;
            var termStart = cursor;
            var startCursor1 = cursor;
            IParseResult<IList<string>> r2 = null;
            var startCursor2 = cursor;
            var l0 = new List<string>();
            while (true)
            {
                IParseResult<string> r3 = null;
                if (r3 == null)
                {
                    r3 = this.ParseClass(ref cursor, "::  \t\t\r\r\n\n\f\f{{}}(())\"\"//^^~~[[]]", negated: true);
                }
                if (r3 == null)
                {
                    var startCursor3 = cursor;
                    IParseResult<string> r4 = null;
                    r4 = this.ParseLiteral(ref cursor, "\\");
                    if (r4 != null)
                    {
                        IParseResult<string> r5 = null;
                        r5 = this.ParseClass(ref cursor, ":\\(())^^~~**");
                        if (r5 != null)
                        {
                            {
                                var len = cursor.Location - startCursor3.Location;
                                r3 = this.ReturnHelper<string>(startCursor3, ref cursor, state =>
                                    state.Subject.Substring(startCursor3.Location, len)
                                    );
                            }
                        }
                        else
                        {
                            cursor = startCursor3;
                        }
                    }
                    else
                    {
                        cursor = startCursor3;
                    }
                }
                if (r3 != null)
                {
                    l0.Add(r3.Value);
                }
                else
                {
                    break;
                }
            }
            if (l0.Count >= 1)
            {
                r2 = this.ReturnHelper<IList<string>>(startCursor2, ref cursor, state => l0.AsReadOnly());
            }
            else
            {
                cursor = startCursor2;
            }
            if (r2 != null)
            {
                IParseResult<string> r6 = null;
                r6 = this.ParseLiteral(ref cursor, "");
                if (r6 != null)
                {
                    {
                        var len = cursor.Location - startCursor1.Location;
                        r1 = this.ReturnHelper<string>(startCursor1, ref cursor, state =>
                            state.Subject.Substring(startCursor1.Location, len)
                            );
                    }
                }
                else
                {
                    cursor = startCursor1;
                }
            }
            else
            {
                cursor = startCursor1;
            }
            var termEnd = cursor;
            var term = ValueOrDefault(r1);
            if (r1 != null)
            {
                r0 = this.ReturnHelper<string>(startCursor0, ref cursor, state =>
                    #line 170 "LuceneQueryParser.peg"
     
        term
                    #line default
                    );
            }
            else
            {
                cursor = startCursor0;
            }
            return r0;
        }

        private IParseResult<string> unquoted_term(ref Cursor cursor)
        {
            IParseResult<string> r0 = null;
            var startCursor0 = cursor;
            IParseResult<string> r1 = null;
            var termStart = cursor;
            var startCursor1 = cursor;
            IParseResult<IList<string>> r2 = null;
            var startCursor2 = cursor;
            var l0 = new List<string>();
            while (true)
            {
                IParseResult<string> r3 = null;
                if (r3 == null)
                {
                    r3 = this.ParseClass(ref cursor, "::  \\\\\t\t\r\r\n\n\f\f{{}}(())//^^~~[[]]", negated: true);
                }
                if (r3 == null)
                {
                    var startCursor3 = cursor;
                    IParseResult<string> r4 = null;
                    r4 = this.ParseLiteral(ref cursor, "\\");
                    if (r4 != null)
                    {
                        IParseResult<string> r5 = null;
                        r5 = this.ParseClass(ref cursor, ":\\(())^^~~**");
                        if (r5 != null)
                        {
                            {
                                var len = cursor.Location - startCursor3.Location;
                                r3 = this.ReturnHelper<string>(startCursor3, ref cursor, state =>
                                    state.Subject.Substring(startCursor3.Location, len)
                                    );
                            }
                        }
                        else
                        {
                            cursor = startCursor3;
                        }
                    }
                    else
                    {
                        cursor = startCursor3;
                    }
                }
                if (r3 != null)
                {
                    l0.Add(r3.Value);
                }
                else
                {
                    break;
                }
            }
            if (l0.Count >= 1)
            {
                r2 = this.ReturnHelper<IList<string>>(startCursor2, ref cursor, state => l0.AsReadOnly());
            }
            else
            {
                cursor = startCursor2;
            }
            if (r2 != null)
            {
                IParseResult<string> r6 = null;
                r6 = this.ParseLiteral(ref cursor, "");
                if (r6 != null)
                {
                    {
                        var len = cursor.Location - startCursor1.Location;
                        r1 = this.ReturnHelper<string>(startCursor1, ref cursor, state =>
                            state.Subject.Substring(startCursor1.Location, len)
                            );
                    }
                }
                else
                {
                    cursor = startCursor1;
                }
            }
            else
            {
                cursor = startCursor1;
            }
            var termEnd = cursor;
            var term = ValueOrDefault(r1);
            if (r1 != null)
            {
                r0 = this.ReturnHelper<string>(startCursor0, ref cursor, state =>
                    #line 176 "LuceneQueryParser.peg"
     
        term
                    #line default
                    );
            }
            else
            {
                cursor = startCursor0;
            }
            return r0;
        }

        private IParseResult<string> range_unquoted_term(ref Cursor cursor)
        {
            IParseResult<string> r0 = null;
            var startCursor0 = cursor;
            IParseResult<string> r1 = null;
            var termStart = cursor;
            if (r1 == null)
            {
                var startCursor1 = cursor;
                IParseResult<IList<string>> r2 = null;
                var startCursor2 = cursor;
                var l0 = new List<string>();
                while (true)
                {
                    IParseResult<string> r3 = null;
                    if (r3 == null)
                    {
                        r3 = this.ParseClass(ref cursor, "::  \\\\..\t\t\r\r\n\n\f\f{{}}(())\"\"^^~~[[]]", negated: true);
                    }
                    if (r3 == null)
                    {
                        var startCursor3 = cursor;
                        IParseResult<string> r4 = null;
                        r4 = this.ParseClass(ref cursor, "..");
                        if (r4 != null)
                        {
                            IParseResult<string> r5 = null;
                            r5 = this.ParseClass(ref cursor, "..", negated: true);
                            if (r5 != null)
                            {
                                {
                                    var len = cursor.Location - startCursor3.Location;
                                    r3 = this.ReturnHelper<string>(startCursor3, ref cursor, state =>
                                        state.Subject.Substring(startCursor3.Location, len)
                                        );
                                }
                            }
                            else
                            {
                                cursor = startCursor3;
                            }
                        }
                        else
                        {
                            cursor = startCursor3;
                        }
                    }
                    if (r3 == null)
                    {
                        var startCursor4 = cursor;
                        IParseResult<string> r6 = null;
                        r6 = this.ParseLiteral(ref cursor, "\\");
                        if (r6 != null)
                        {
                            IParseResult<string> r7 = null;
                            r7 = this.ParseClass(ref cursor, ":\\(())^^~~**");
                            if (r7 != null)
                            {
                                {
                                    var len = cursor.Location - startCursor4.Location;
                                    r3 = this.ReturnHelper<string>(startCursor4, ref cursor, state =>
                                        state.Subject.Substring(startCursor4.Location, len)
                                        );
                                }
                            }
                            else
                            {
                                cursor = startCursor4;
                            }
                        }
                        else
                        {
                            cursor = startCursor4;
                        }
                    }
                    if (r3 != null)
                    {
                        l0.Add(r3.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                if (l0.Count >= 1)
                {
                    r2 = this.ReturnHelper<IList<string>>(startCursor2, ref cursor, state => l0.AsReadOnly());
                }
                else
                {
                    cursor = startCursor2;
                }
                if (r2 != null)
                {
                    IParseResult<string> r8 = null;
                    r8 = this.ParseLiteral(ref cursor, "");
                    if (r8 != null)
                    {
                        {
                            var len = cursor.Location - startCursor1.Location;
                            r1 = this.ReturnHelper<string>(startCursor1, ref cursor, state =>
                                state.Subject.Substring(startCursor1.Location, len)
                                );
                        }
                    }
                    else
                    {
                        cursor = startCursor1;
                    }
                }
                else
                {
                    cursor = startCursor1;
                }
            }
            if (r1 == null)
            {
                r1 = this.ParseLiteral(ref cursor, "*");
            }
            var termEnd = cursor;
            var term = ValueOrDefault(r1);
            if (r1 != null)
            {
                r0 = this.ReturnHelper<string>(startCursor0, ref cursor, state =>
                    #line 182 "LuceneQueryParser.peg"
     
        term
                    #line default
                    );
            }
            else
            {
                cursor = startCursor0;
            }
            return r0;
        }

        private IParseResult<string> quoted_term(ref Cursor cursor)
        {
            IParseResult<string> r0 = null;
            var startCursor0 = cursor;
            IParseResult<string> r1 = null;
            r1 = this.ParseLiteral(ref cursor, "\"");
            if (r1 != null)
            {
                IParseResult<string> r2 = null;
                var termStart = cursor;
                var startCursor1 = cursor;
                IParseResult<IList<string>> r3 = null;
                var startCursor2 = cursor;
                var l0 = new List<string>();
                while (true)
                {
                    IParseResult<string> r4 = null;
                    r4 = this.ParseClass(ref cursor, "\"\"", negated: true);
                    if (r4 != null)
                    {
                        l0.Add(r4.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                if (l0.Count >= 1)
                {
                    r3 = this.ReturnHelper<IList<string>>(startCursor2, ref cursor, state => l0.AsReadOnly());
                }
                else
                {
                    cursor = startCursor2;
                }
                if (r3 != null)
                {
                    IParseResult<string> r5 = null;
                    r5 = this.ParseLiteral(ref cursor, "");
                    if (r5 != null)
                    {
                        {
                            var len = cursor.Location - startCursor1.Location;
                            r2 = this.ReturnHelper<string>(startCursor1, ref cursor, state =>
                                state.Subject.Substring(startCursor1.Location, len)
                                );
                        }
                    }
                    else
                    {
                        cursor = startCursor1;
                    }
                }
                else
                {
                    cursor = startCursor1;
                }
                var termEnd = cursor;
                var term = ValueOrDefault(r2);
                if (r2 != null)
                {
                    IParseResult<string> r6 = null;
                    r6 = this.ParseLiteral(ref cursor, "\"");
                    if (r6 != null)
                    {
                        r0 = this.ReturnHelper<string>(startCursor0, ref cursor, state =>
                            #line 188 "LuceneQueryParser.peg"
     
        term
                            #line default
                            );
                    }
                    else
                    {
                        cursor = startCursor0;
                    }
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            else
            {
                cursor = startCursor0;
            }
            return r0;
        }

        private IParseResult<
            #line 192 "LuceneQueryParser.peg"
               string
            #line default
            > boost_modifier(ref Cursor cursor)
        {
            IParseResult<string> r0 = null;
            var startCursor0 = cursor;
            IParseResult<string> r1 = null;
            r1 = this.ParseLiteral(ref cursor, "^");
            if (r1 != null)
            {
                IParseResult<string> r2 = null;
                var boostStart = cursor;
                r2 = this.unquoted_term(ref cursor);
                var boostEnd = cursor;
                var boost = ValueOrDefault(r2);
                if (r2 != null)
                {
                    r0 = this.ReturnHelper<string>(startCursor0, ref cursor, state =>
                        #line 194 "LuceneQueryParser.peg"
     
        boost
                        #line default
                        );
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            else
            {
                cursor = startCursor0;
            }
            return r0;
        }

        private IParseResult<
            #line 198 "LuceneQueryParser.peg"
                   string
            #line default
            > proximity_modifier(ref Cursor cursor)
        {
            IParseResult<string> r0 = null;
            var startCursor0 = cursor;
            IParseResult<string> r1 = null;
            r1 = this.ParseLiteral(ref cursor, "~");
            if (r1 != null)
            {
                IParseResult<string> r2 = null;
                var proximityStart = cursor;
                var startCursor1 = cursor;
                IParseResult<IList<string>> r3 = null;
                var startCursor2 = cursor;
                var l0 = new List<string>();
                while (l0.Count < 1)
                {
                    IParseResult<string> r4 = null;
                    r4 = this.unquoted_term(ref cursor);
                    if (r4 != null)
                    {
                        l0.Add(r4.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r3 = this.ReturnHelper<IList<string>>(startCursor2, ref cursor, state => l0.AsReadOnly());
                if (r3 != null)
                {
                    IParseResult<string> r5 = null;
                    r5 = this.ParseLiteral(ref cursor, "");
                    if (r5 != null)
                    {
                        {
                            var len = cursor.Location - startCursor1.Location;
                            r2 = this.ReturnHelper<string>(startCursor1, ref cursor, state =>
                                state.Subject.Substring(startCursor1.Location, len)
                                );
                        }
                    }
                    else
                    {
                        cursor = startCursor1;
                    }
                }
                else
                {
                    cursor = startCursor1;
                }
                var proximityEnd = cursor;
                var proximity = ValueOrDefault(r2);
                if (r2 != null)
                {
                    r0 = this.ReturnHelper<string>(startCursor0, ref cursor, state =>
                        #line 200 "LuceneQueryParser.peg"
     
        proximity
                        #line default
                        );
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            else
            {
                cursor = startCursor0;
            }
            return r0;
        }

        private IParseResult<
            #line 204 "LuceneQueryParser.peg"
                   TermRangeNode
            #line default
            > range_operator_exp(ref Cursor cursor)
        {
            IParseResult<TermRangeNode> r0 = null;
            if (r0 == null)
            {
                var startCursor0 = cursor;
                IParseResult<string> r1 = null;
                r1 = this.ParseLiteral(ref cursor, "[");
                if (r1 != null)
                {
                    IParseResult<IList<IList<string>>> r2 = null;
                    var startCursor1 = cursor;
                    var l0 = new List<IList<string>>();
                    while (true)
                    {
                        IParseResult<IList<string>> r3 = null;
                        r3 = this._(ref cursor);
                        if (r3 != null)
                        {
                            l0.Add(r3.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r2 = this.ReturnHelper<IList<IList<string>>>(startCursor1, ref cursor, state => l0.AsReadOnly());
                    if (r2 != null)
                    {
                        IParseResult<string> r4 = null;
                        var term_minStart = cursor;
                        r4 = this.range_unquoted_term(ref cursor);
                        var term_minEnd = cursor;
                        var term_min = ValueOrDefault(r4);
                        if (r4 != null)
                        {
                            IParseResult<string> r5 = null;
                            var delimStart = cursor;
                            r5 = this.range_delimiter_exp(ref cursor);
                            var delimEnd = cursor;
                            var delim = ValueOrDefault(r5);
                            if (r5 != null)
                            {
                                IParseResult<string> r6 = null;
                                var term_maxStart = cursor;
                                r6 = this.range_unquoted_term(ref cursor);
                                var term_maxEnd = cursor;
                                var term_max = ValueOrDefault(r6);
                                if (r6 != null)
                                {
                                    IParseResult<IList<IList<string>>> r7 = null;
                                    var startCursor2 = cursor;
                                    var l1 = new List<IList<string>>();
                                    while (true)
                                    {
                                        IParseResult<IList<string>> r8 = null;
                                        r8 = this._(ref cursor);
                                        if (r8 != null)
                                        {
                                            l1.Add(r8.Value);
                                        }
                                        else
                                        {
                                            break;
                                        }
                                    }
                                    r7 = this.ReturnHelper<IList<IList<string>>>(startCursor2, ref cursor, state => l1.AsReadOnly());
                                    if (r7 != null)
                                    {
                                        IParseResult<string> r9 = null;
                                        r9 = this.ParseLiteral(ref cursor, "]");
                                        if (r9 != null)
                                        {
                                            r0 = this.ReturnHelper<TermRangeNode>(startCursor0, ref cursor, state =>
                                                #line 206 "LuceneQueryParser.peg"
     
        new TermRangeNode {
            Min = term_min,
            Max = term_max,
            MinInclusive = true,
            MaxInclusive = true,
            Delimiter = delim
        }
                                                #line default
                                                );
                                        }
                                        else
                                        {
                                            cursor = startCursor0;
                                        }
                                    }
                                    else
                                    {
                                        cursor = startCursor0;
                                    }
                                }
                                else
                                {
                                    cursor = startCursor0;
                                }
                            }
                            else
                            {
                                cursor = startCursor0;
                            }
                        }
                        else
                        {
                            cursor = startCursor0;
                        }
                    }
                    else
                    {
                        cursor = startCursor0;
                    }
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            if (r0 == null)
            {
                var startCursor3 = cursor;
                IParseResult<string> r10 = null;
                r10 = this.ParseLiteral(ref cursor, "{");
                if (r10 != null)
                {
                    IParseResult<IList<IList<string>>> r11 = null;
                    var startCursor4 = cursor;
                    var l2 = new List<IList<string>>();
                    while (true)
                    {
                        IParseResult<IList<string>> r12 = null;
                        r12 = this._(ref cursor);
                        if (r12 != null)
                        {
                            l2.Add(r12.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r11 = this.ReturnHelper<IList<IList<string>>>(startCursor4, ref cursor, state => l2.AsReadOnly());
                    if (r11 != null)
                    {
                        IParseResult<string> r13 = null;
                        var term_minStart = cursor;
                        r13 = this.range_unquoted_term(ref cursor);
                        var term_minEnd = cursor;
                        var term_min = ValueOrDefault(r13);
                        if (r13 != null)
                        {
                            IParseResult<string> r14 = null;
                            var delimStart = cursor;
                            r14 = this.range_delimiter_exp(ref cursor);
                            var delimEnd = cursor;
                            var delim = ValueOrDefault(r14);
                            if (r14 != null)
                            {
                                IParseResult<string> r15 = null;
                                var term_maxStart = cursor;
                                r15 = this.range_unquoted_term(ref cursor);
                                var term_maxEnd = cursor;
                                var term_max = ValueOrDefault(r15);
                                if (r15 != null)
                                {
                                    IParseResult<IList<IList<string>>> r16 = null;
                                    var startCursor5 = cursor;
                                    var l3 = new List<IList<string>>();
                                    while (true)
                                    {
                                        IParseResult<IList<string>> r17 = null;
                                        r17 = this._(ref cursor);
                                        if (r17 != null)
                                        {
                                            l3.Add(r17.Value);
                                        }
                                        else
                                        {
                                            break;
                                        }
                                    }
                                    r16 = this.ReturnHelper<IList<IList<string>>>(startCursor5, ref cursor, state => l3.AsReadOnly());
                                    if (r16 != null)
                                    {
                                        IParseResult<string> r18 = null;
                                        r18 = this.ParseLiteral(ref cursor, "}");
                                        if (r18 != null)
                                        {
                                            r0 = this.ReturnHelper<TermRangeNode>(startCursor3, ref cursor, state =>
                                                #line 216 "LuceneQueryParser.peg"
     
        new TermRangeNode {
            Min = term_min,
            Max = term_max,
            MinInclusive = false,
            MaxInclusive = false,
            Delimiter = delim
        }
                                                #line default
                                                );
                                        }
                                        else
                                        {
                                            cursor = startCursor3;
                                        }
                                    }
                                    else
                                    {
                                        cursor = startCursor3;
                                    }
                                }
                                else
                                {
                                    cursor = startCursor3;
                                }
                            }
                            else
                            {
                                cursor = startCursor3;
                            }
                        }
                        else
                        {
                            cursor = startCursor3;
                        }
                    }
                    else
                    {
                        cursor = startCursor3;
                    }
                }
                else
                {
                    cursor = startCursor3;
                }
            }
            if (r0 == null)
            {
                var startCursor6 = cursor;
                IParseResult<string> r19 = null;
                r19 = this.ParseLiteral(ref cursor, "{");
                if (r19 != null)
                {
                    IParseResult<IList<IList<string>>> r20 = null;
                    var startCursor7 = cursor;
                    var l4 = new List<IList<string>>();
                    while (true)
                    {
                        IParseResult<IList<string>> r21 = null;
                        r21 = this._(ref cursor);
                        if (r21 != null)
                        {
                            l4.Add(r21.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r20 = this.ReturnHelper<IList<IList<string>>>(startCursor7, ref cursor, state => l4.AsReadOnly());
                    if (r20 != null)
                    {
                        IParseResult<string> r22 = null;
                        var term_minStart = cursor;
                        r22 = this.range_unquoted_term(ref cursor);
                        var term_minEnd = cursor;
                        var term_min = ValueOrDefault(r22);
                        if (r22 != null)
                        {
                            IParseResult<string> r23 = null;
                            var delimStart = cursor;
                            r23 = this.range_delimiter_exp(ref cursor);
                            var delimEnd = cursor;
                            var delim = ValueOrDefault(r23);
                            if (r23 != null)
                            {
                                IParseResult<string> r24 = null;
                                var term_maxStart = cursor;
                                r24 = this.range_unquoted_term(ref cursor);
                                var term_maxEnd = cursor;
                                var term_max = ValueOrDefault(r24);
                                if (r24 != null)
                                {
                                    IParseResult<IList<IList<string>>> r25 = null;
                                    var startCursor8 = cursor;
                                    var l5 = new List<IList<string>>();
                                    while (true)
                                    {
                                        IParseResult<IList<string>> r26 = null;
                                        r26 = this._(ref cursor);
                                        if (r26 != null)
                                        {
                                            l5.Add(r26.Value);
                                        }
                                        else
                                        {
                                            break;
                                        }
                                    }
                                    r25 = this.ReturnHelper<IList<IList<string>>>(startCursor8, ref cursor, state => l5.AsReadOnly());
                                    if (r25 != null)
                                    {
                                        IParseResult<string> r27 = null;
                                        r27 = this.ParseLiteral(ref cursor, "]");
                                        if (r27 != null)
                                        {
                                            r0 = this.ReturnHelper<TermRangeNode>(startCursor6, ref cursor, state =>
                                                #line 226 "LuceneQueryParser.peg"
     
        new TermRangeNode {
            Min = term_min,
            Max = term_max,
            MinInclusive = false,
            MaxInclusive = true,
            Delimiter = delim
        }
                                                #line default
                                                );
                                        }
                                        else
                                        {
                                            cursor = startCursor6;
                                        }
                                    }
                                    else
                                    {
                                        cursor = startCursor6;
                                    }
                                }
                                else
                                {
                                    cursor = startCursor6;
                                }
                            }
                            else
                            {
                                cursor = startCursor6;
                            }
                        }
                        else
                        {
                            cursor = startCursor6;
                        }
                    }
                    else
                    {
                        cursor = startCursor6;
                    }
                }
                else
                {
                    cursor = startCursor6;
                }
            }
            if (r0 == null)
            {
                var startCursor9 = cursor;
                IParseResult<string> r28 = null;
                r28 = this.ParseLiteral(ref cursor, "[");
                if (r28 != null)
                {
                    IParseResult<IList<IList<string>>> r29 = null;
                    var startCursor10 = cursor;
                    var l6 = new List<IList<string>>();
                    while (true)
                    {
                        IParseResult<IList<string>> r30 = null;
                        r30 = this._(ref cursor);
                        if (r30 != null)
                        {
                            l6.Add(r30.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r29 = this.ReturnHelper<IList<IList<string>>>(startCursor10, ref cursor, state => l6.AsReadOnly());
                    if (r29 != null)
                    {
                        IParseResult<string> r31 = null;
                        var term_minStart = cursor;
                        r31 = this.range_unquoted_term(ref cursor);
                        var term_minEnd = cursor;
                        var term_min = ValueOrDefault(r31);
                        if (r31 != null)
                        {
                            IParseResult<string> r32 = null;
                            var delimStart = cursor;
                            r32 = this.range_delimiter_exp(ref cursor);
                            var delimEnd = cursor;
                            var delim = ValueOrDefault(r32);
                            if (r32 != null)
                            {
                                IParseResult<string> r33 = null;
                                var term_maxStart = cursor;
                                r33 = this.range_unquoted_term(ref cursor);
                                var term_maxEnd = cursor;
                                var term_max = ValueOrDefault(r33);
                                if (r33 != null)
                                {
                                    IParseResult<IList<IList<string>>> r34 = null;
                                    var startCursor11 = cursor;
                                    var l7 = new List<IList<string>>();
                                    while (true)
                                    {
                                        IParseResult<IList<string>> r35 = null;
                                        r35 = this._(ref cursor);
                                        if (r35 != null)
                                        {
                                            l7.Add(r35.Value);
                                        }
                                        else
                                        {
                                            break;
                                        }
                                    }
                                    r34 = this.ReturnHelper<IList<IList<string>>>(startCursor11, ref cursor, state => l7.AsReadOnly());
                                    if (r34 != null)
                                    {
                                        IParseResult<string> r36 = null;
                                        r36 = this.ParseLiteral(ref cursor, "}");
                                        if (r36 != null)
                                        {
                                            r0 = this.ReturnHelper<TermRangeNode>(startCursor9, ref cursor, state =>
                                                #line 236 "LuceneQueryParser.peg"
     
        new TermRangeNode {
            Min = term_min,
            Max = term_max,
            MinInclusive = true,
            MaxInclusive = false,
            Delimiter = delim
        }
                                                #line default
                                                );
                                        }
                                        else
                                        {
                                            cursor = startCursor9;
                                        }
                                    }
                                    else
                                    {
                                        cursor = startCursor9;
                                    }
                                }
                                else
                                {
                                    cursor = startCursor9;
                                }
                            }
                            else
                            {
                                cursor = startCursor9;
                            }
                        }
                        else
                        {
                            cursor = startCursor9;
                        }
                    }
                    else
                    {
                        cursor = startCursor9;
                    }
                }
                else
                {
                    cursor = startCursor9;
                }
            }
            if (r0 == null)
            {
                var startCursor12 = cursor;
                IParseResult<string> r37 = null;
                r37 = this.ParseLiteral(ref cursor, ">=");
                if (r37 != null)
                {
                    IParseResult<IList<IList<string>>> r38 = null;
                    var startCursor13 = cursor;
                    var l8 = new List<IList<string>>();
                    while (true)
                    {
                        IParseResult<IList<string>> r39 = null;
                        r39 = this._(ref cursor);
                        if (r39 != null)
                        {
                            l8.Add(r39.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r38 = this.ReturnHelper<IList<IList<string>>>(startCursor13, ref cursor, state => l8.AsReadOnly());
                    if (r38 != null)
                    {
                        IParseResult<string> r40 = null;
                        var term_minStart = cursor;
                        r40 = this.range_unquoted_term(ref cursor);
                        var term_minEnd = cursor;
                        var term_min = ValueOrDefault(r40);
                        if (r40 != null)
                        {
                            r0 = this.ReturnHelper<TermRangeNode>(startCursor12, ref cursor, state =>
                                #line 246 "LuceneQueryParser.peg"
     
        new TermRangeNode {
            Min = term_min,
            MinInclusive = true,
            Operator = ">="
        }
                                #line default
                                );
                        }
                        else
                        {
                            cursor = startCursor12;
                        }
                    }
                    else
                    {
                        cursor = startCursor12;
                    }
                }
                else
                {
                    cursor = startCursor12;
                }
            }
            if (r0 == null)
            {
                var startCursor14 = cursor;
                IParseResult<string> r41 = null;
                r41 = this.ParseLiteral(ref cursor, ">");
                if (r41 != null)
                {
                    IParseResult<IList<IList<string>>> r42 = null;
                    var startCursor15 = cursor;
                    var l9 = new List<IList<string>>();
                    while (true)
                    {
                        IParseResult<IList<string>> r43 = null;
                        r43 = this._(ref cursor);
                        if (r43 != null)
                        {
                            l9.Add(r43.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r42 = this.ReturnHelper<IList<IList<string>>>(startCursor15, ref cursor, state => l9.AsReadOnly());
                    if (r42 != null)
                    {
                        IParseResult<string> r44 = null;
                        var term_minStart = cursor;
                        r44 = this.range_unquoted_term(ref cursor);
                        var term_minEnd = cursor;
                        var term_min = ValueOrDefault(r44);
                        if (r44 != null)
                        {
                            r0 = this.ReturnHelper<TermRangeNode>(startCursor14, ref cursor, state =>
                                #line 254 "LuceneQueryParser.peg"
     
        new TermRangeNode {
            Min = term_min,
            MinInclusive = false,
            Operator = ">"
        }
                                #line default
                                );
                        }
                        else
                        {
                            cursor = startCursor14;
                        }
                    }
                    else
                    {
                        cursor = startCursor14;
                    }
                }
                else
                {
                    cursor = startCursor14;
                }
            }
            if (r0 == null)
            {
                var startCursor16 = cursor;
                IParseResult<string> r45 = null;
                r45 = this.ParseLiteral(ref cursor, "<=");
                if (r45 != null)
                {
                    IParseResult<IList<IList<string>>> r46 = null;
                    var startCursor17 = cursor;
                    var l10 = new List<IList<string>>();
                    while (true)
                    {
                        IParseResult<IList<string>> r47 = null;
                        r47 = this._(ref cursor);
                        if (r47 != null)
                        {
                            l10.Add(r47.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r46 = this.ReturnHelper<IList<IList<string>>>(startCursor17, ref cursor, state => l10.AsReadOnly());
                    if (r46 != null)
                    {
                        IParseResult<string> r48 = null;
                        var term_maxStart = cursor;
                        r48 = this.range_unquoted_term(ref cursor);
                        var term_maxEnd = cursor;
                        var term_max = ValueOrDefault(r48);
                        if (r48 != null)
                        {
                            r0 = this.ReturnHelper<TermRangeNode>(startCursor16, ref cursor, state =>
                                #line 262 "LuceneQueryParser.peg"
     
        new TermRangeNode {
            Max = term_max,
            MaxInclusive = true,
            Operator = "<="
        }
                                #line default
                                );
                        }
                        else
                        {
                            cursor = startCursor16;
                        }
                    }
                    else
                    {
                        cursor = startCursor16;
                    }
                }
                else
                {
                    cursor = startCursor16;
                }
            }
            if (r0 == null)
            {
                var startCursor18 = cursor;
                IParseResult<string> r49 = null;
                r49 = this.ParseLiteral(ref cursor, "<");
                if (r49 != null)
                {
                    IParseResult<IList<IList<string>>> r50 = null;
                    var startCursor19 = cursor;
                    var l11 = new List<IList<string>>();
                    while (true)
                    {
                        IParseResult<IList<string>> r51 = null;
                        r51 = this._(ref cursor);
                        if (r51 != null)
                        {
                            l11.Add(r51.Value);
                        }
                        else
                        {
                            break;
                        }
                    }
                    r50 = this.ReturnHelper<IList<IList<string>>>(startCursor19, ref cursor, state => l11.AsReadOnly());
                    if (r50 != null)
                    {
                        IParseResult<string> r52 = null;
                        var term_maxStart = cursor;
                        r52 = this.range_unquoted_term(ref cursor);
                        var term_maxEnd = cursor;
                        var term_max = ValueOrDefault(r52);
                        if (r52 != null)
                        {
                            r0 = this.ReturnHelper<TermRangeNode>(startCursor18, ref cursor, state =>
                                #line 270 "LuceneQueryParser.peg"
     
        new TermRangeNode {
            Max = term_max,
            MaxInclusive = false,
            Operator = "<"
        }
                                #line default
                                );
                        }
                        else
                        {
                            cursor = startCursor18;
                        }
                    }
                    else
                    {
                        cursor = startCursor18;
                    }
                }
                else
                {
                    cursor = startCursor18;
                }
            }
            return r0;
        }

        private IParseResult<string> range_delimiter_exp(ref Cursor cursor)
        {
            IParseResult<string> r0 = null;
            if (r0 == null)
            {
                var startCursor0 = cursor;
                IParseResult<IList<IList<string>>> r1 = null;
                var startCursor1 = cursor;
                var l0 = new List<IList<string>>();
                while (true)
                {
                    IParseResult<IList<string>> r2 = null;
                    r2 = this._(ref cursor);
                    if (r2 != null)
                    {
                        l0.Add(r2.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                if (l0.Count >= 1)
                {
                    r1 = this.ReturnHelper<IList<IList<string>>>(startCursor1, ref cursor, state => l0.AsReadOnly());
                }
                else
                {
                    cursor = startCursor1;
                }
                if (r1 != null)
                {
                    IParseResult<string> r3 = null;
                    r3 = this.ParseLiteral(ref cursor, "TO");
                    if (r3 != null)
                    {
                        IParseResult<IList<IList<string>>> r4 = null;
                        var startCursor2 = cursor;
                        var l1 = new List<IList<string>>();
                        while (true)
                        {
                            IParseResult<IList<string>> r5 = null;
                            r5 = this._(ref cursor);
                            if (r5 != null)
                            {
                                l1.Add(r5.Value);
                            }
                            else
                            {
                                break;
                            }
                        }
                        if (l1.Count >= 1)
                        {
                            r4 = this.ReturnHelper<IList<IList<string>>>(startCursor2, ref cursor, state => l1.AsReadOnly());
                        }
                        else
                        {
                            cursor = startCursor2;
                        }
                        if (r4 != null)
                        {
                            {
                                var len = cursor.Location - startCursor0.Location;
                                r0 = this.ReturnHelper<string>(startCursor0, ref cursor, state =>
                                    state.Subject.Substring(startCursor0.Location, len)
                                    , ruleName: "range_delimiter_exp");
                            }
                        }
                        else
                        {
                            cursor = startCursor0;
                        }
                    }
                    else
                    {
                        cursor = startCursor0;
                    }
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            if (r0 == null)
            {
                var startCursor3 = cursor;
                IParseResult<IList<IList<string>>> r6 = null;
                var startCursor4 = cursor;
                var l2 = new List<IList<string>>();
                while (true)
                {
                    IParseResult<IList<string>> r7 = null;
                    r7 = this._(ref cursor);
                    if (r7 != null)
                    {
                        l2.Add(r7.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r6 = this.ReturnHelper<IList<IList<string>>>(startCursor4, ref cursor, state => l2.AsReadOnly());
                if (r6 != null)
                {
                    IParseResult<string> r8 = null;
                    r8 = this.ParseLiteral(ref cursor, "..");
                    if (r8 != null)
                    {
                        IParseResult<IList<IList<string>>> r9 = null;
                        var startCursor5 = cursor;
                        var l3 = new List<IList<string>>();
                        while (true)
                        {
                            IParseResult<IList<string>> r10 = null;
                            r10 = this._(ref cursor);
                            if (r10 != null)
                            {
                                l3.Add(r10.Value);
                            }
                            else
                            {
                                break;
                            }
                        }
                        r9 = this.ReturnHelper<IList<IList<string>>>(startCursor5, ref cursor, state => l3.AsReadOnly());
                        if (r9 != null)
                        {
                            {
                                var len = cursor.Location - startCursor3.Location;
                                r0 = this.ReturnHelper<string>(startCursor3, ref cursor, state =>
                                    state.Subject.Substring(startCursor3.Location, len)
                                    , ruleName: "range_delimiter_exp");
                            }
                        }
                        else
                        {
                            cursor = startCursor3;
                        }
                    }
                    else
                    {
                        cursor = startCursor3;
                    }
                }
                else
                {
                    cursor = startCursor3;
                }
            }
            return r0;
        }

        private IParseResult<string> not_exp(ref Cursor cursor)
        {
            IParseResult<string> r0 = null;
            var startCursor0 = cursor;
            IParseResult<string> r1 = null;
            r1 = this.ParseLiteral(ref cursor, "NOT");
            if (r1 != null)
            {
                IParseResult<IList<IList<string>>> r2 = null;
                var startCursor1 = cursor;
                var l0 = new List<IList<string>>();
                while (true)
                {
                    IParseResult<IList<string>> r3 = null;
                    r3 = this._(ref cursor);
                    if (r3 != null)
                    {
                        l0.Add(r3.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                if (l0.Count >= 1)
                {
                    r2 = this.ReturnHelper<IList<IList<string>>>(startCursor1, ref cursor, state => l0.AsReadOnly());
                }
                else
                {
                    cursor = startCursor1;
                }
                if (r2 != null)
                {
                    {
                        var len = cursor.Location - startCursor0.Location;
                        r0 = this.ReturnHelper<string>(startCursor0, ref cursor, state =>
                            state.Subject.Substring(startCursor0.Location, len)
                            );
                    }
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            else
            {
                cursor = startCursor0;
            }
            return r0;
        }

        private IParseResult<
            #line 285 "LuceneQueryParser.peg"
             GroupOperator
            #line default
            > operator_exp(ref Cursor cursor)
        {
            IParseResult<GroupOperator> r0 = null;
            if (r0 == null)
            {
                var startCursor0 = cursor;
                IParseResult<IList<IList<string>>> r1 = null;
                var startCursor1 = cursor;
                var l0 = new List<IList<string>>();
                while (true)
                {
                    IParseResult<IList<string>> r2 = null;
                    r2 = this._(ref cursor);
                    if (r2 != null)
                    {
                        l0.Add(r2.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r1 = this.ReturnHelper<IList<IList<string>>>(startCursor1, ref cursor, state => l0.AsReadOnly());
                if (r1 != null)
                {
                    IParseResult<GroupOperator> r3 = null;
                    var opStart = cursor;
                    r3 = this.@operator(ref cursor);
                    var opEnd = cursor;
                    var op = ValueOrDefault(r3);
                    if (r3 != null)
                    {
                        IParseResult<IList<IList<string>>> r4 = null;
                        var startCursor2 = cursor;
                        var l1 = new List<IList<string>>();
                        while (true)
                        {
                            IParseResult<IList<string>> r5 = null;
                            r5 = this._(ref cursor);
                            if (r5 != null)
                            {
                                l1.Add(r5.Value);
                            }
                            else
                            {
                                break;
                            }
                        }
                        if (l1.Count >= 1)
                        {
                            r4 = this.ReturnHelper<IList<IList<string>>>(startCursor2, ref cursor, state => l1.AsReadOnly());
                        }
                        else
                        {
                            cursor = startCursor2;
                        }
                        if (r4 != null)
                        {
                            r0 = this.ReturnHelper<GroupOperator>(startCursor0, ref cursor, state =>
                                #line 287 "LuceneQueryParser.peg"
     
        op
                                #line default
                                );
                        }
                        else
                        {
                            cursor = startCursor0;
                        }
                    }
                    else
                    {
                        cursor = startCursor0;
                    }
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            if (r0 == null)
            {
                var startCursor3 = cursor;
                IParseResult<IList<IList<string>>> r6 = null;
                var startCursor4 = cursor;
                var l2 = new List<IList<string>>();
                while (true)
                {
                    IParseResult<IList<string>> r7 = null;
                    r7 = this._(ref cursor);
                    if (r7 != null)
                    {
                        l2.Add(r7.Value);
                    }
                    else
                    {
                        break;
                    }
                }
                r6 = this.ReturnHelper<IList<IList<string>>>(startCursor4, ref cursor, state => l2.AsReadOnly());
                if (r6 != null)
                {
                    IParseResult<GroupOperator> r8 = null;
                    var opStart = cursor;
                    r8 = this.@operator(ref cursor);
                    var opEnd = cursor;
                    var op = ValueOrDefault(r8);
                    if (r8 != null)
                    {
                        IParseResult<string> r9 = null;
                        r9 = this.EOF(ref cursor);
                        if (r9 != null)
                        {
                            r0 = this.ReturnHelper<GroupOperator>(startCursor3, ref cursor, state =>
                                #line 291 "LuceneQueryParser.peg"
     
        op
                                #line default
                                );
                        }
                        else
                        {
                            cursor = startCursor3;
                        }
                    }
                    else
                    {
                        cursor = startCursor3;
                    }
                }
                else
                {
                    cursor = startCursor3;
                }
            }
            return r0;
        }

        private IParseResult<
            #line 295 "LuceneQueryParser.peg"
         GroupOperator
            #line default
            > @operator(ref Cursor cursor)
        {
            IParseResult<GroupOperator> r0 = null;
            if (r0 == null)
            {
                var startCursor0 = cursor;
                IParseResult<string> r1 = null;
                r1 = this.ParseLiteral(ref cursor, "OR");
                if (r1 != null)
                {
                    r0 = this.ReturnHelper<GroupOperator>(startCursor0, ref cursor, state =>
                        #line 296 "LuceneQueryParser.peg"
           GroupOperator.Or
                        #line default
                        , ruleName: "operator");
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            if (r0 == null)
            {
                var startCursor1 = cursor;
                IParseResult<string> r2 = null;
                r2 = this.ParseLiteral(ref cursor, "AND");
                if (r2 != null)
                {
                    r0 = this.ReturnHelper<GroupOperator>(startCursor1, ref cursor, state =>
                        #line 297 "LuceneQueryParser.peg"
           GroupOperator.And
                        #line default
                        , ruleName: "operator");
                }
                else
                {
                    cursor = startCursor1;
                }
            }
            if (r0 == null)
            {
                var startCursor2 = cursor;
                IParseResult<string> r3 = null;
                r3 = this.ParseLiteral(ref cursor, "||");
                if (r3 != null)
                {
                    r0 = this.ReturnHelper<GroupOperator>(startCursor2, ref cursor, state =>
                        #line 298 "LuceneQueryParser.peg"
           GroupOperator.Or
                        #line default
                        , ruleName: "operator");
                }
                else
                {
                    cursor = startCursor2;
                }
            }
            if (r0 == null)
            {
                var startCursor3 = cursor;
                IParseResult<string> r4 = null;
                r4 = this.ParseLiteral(ref cursor, "&&");
                if (r4 != null)
                {
                    r0 = this.ReturnHelper<GroupOperator>(startCursor3, ref cursor, state =>
                        #line 299 "LuceneQueryParser.peg"
           GroupOperator.And
                        #line default
                        , ruleName: "operator");
                }
                else
                {
                    cursor = startCursor3;
                }
            }
            return r0;
        }

        private IParseResult<string> prefix_operator_exp(ref Cursor cursor)
        {
            IParseResult<string> r0 = null;
            var startCursor0 = cursor;
            IParseResult<IList<IList<string>>> r1 = null;
            var startCursor1 = cursor;
            var l0 = new List<IList<string>>();
            while (true)
            {
                IParseResult<IList<string>> r2 = null;
                r2 = this._(ref cursor);
                if (r2 != null)
                {
                    l0.Add(r2.Value);
                }
                else
                {
                    break;
                }
            }
            r1 = this.ReturnHelper<IList<IList<string>>>(startCursor1, ref cursor, state => l0.AsReadOnly());
            if (r1 != null)
            {
                IParseResult<string> r3 = null;
                var opStart = cursor;
                r3 = this.prefix_operator(ref cursor);
                var opEnd = cursor;
                var op = ValueOrDefault(r3);
                if (r3 != null)
                {
                    r0 = this.ReturnHelper<string>(startCursor0, ref cursor, state =>
                        #line 303 "LuceneQueryParser.peg"
     
        op
                        #line default
                        );
                }
                else
                {
                    cursor = startCursor0;
                }
            }
            else
            {
                cursor = startCursor0;
            }
            return r0;
        }

        private IParseResult<string> prefix_operator(ref Cursor cursor)
        {
            IParseResult<string> r0 = null;
            if (r0 == null)
            {
                r0 = this.ParseLiteral(ref cursor, "+", ruleName: "prefix_operator");
            }
            if (r0 == null)
            {
                r0 = this.ParseLiteral(ref cursor, "-", ruleName: "prefix_operator");
            }
            return r0;
        }

        private IParseResult<IList<string>> _(ref Cursor cursor)
        {
            IParseResult<IList<string>> r0 = null;
            var startCursor0 = cursor;
            var l0 = new List<string>();
            while (true)
            {
                IParseResult<string> r1 = null;
                r1 = this.ParseClass(ref cursor, "  \t\t\r\r\n\n\f\f");
                if (r1 != null)
                {
                    l0.Add(r1.Value);
                }
                else
                {
                    break;
                }
            }
            if (l0.Count >= 1)
            {
                r0 = this.ReturnHelper<IList<string>>(startCursor0, ref cursor, state => l0.AsReadOnly());
            }
            else
            {
                cursor = startCursor0;
            }
            return r0;
        }

        private IParseResult<string> EOF(ref Cursor cursor)
        {
            IParseResult<string> r0 = null;
            var startCursor0 = cursor;
            IParseResult<string> r1 = null;
            r1 = this.ParseAny(ref cursor);
            if (r1 == null)
            {
                r0 = this.ReturnHelper<string>(cursor, ref cursor, state => string.Empty);
            }
            else
            {
                cursor = startCursor0;
            }
            return r0;
        }

        private IParseResult<string> ParseLiteral(ref Cursor cursor, string literal, bool ignoreCase = false, string ruleName = null)
        {
            if (cursor.Location + literal.Length <= cursor.Subject.Length)
            {
                var substr = cursor.Subject.Substring(cursor.Location, literal.Length);
                if (ignoreCase ? substr.Equals(literal, StringComparison.OrdinalIgnoreCase) : substr == literal)
                {
                    var endCursor = cursor.Advance(substr.Length);
                    var result = this.ReturnHelper<string>(cursor, ref endCursor, state => substr, ruleName);
                    cursor = endCursor;
                    return result;
                }
            }
            return null;
        }

        private IParseResult<string> ParseClass(ref Cursor cursor, string characterRanges, bool negated = false, bool ignoreCase = false, string ruleName = null)
        {
            if (cursor.Location + 1 <= cursor.Subject.Length)
            {
                var c = cursor.Subject[cursor.Location];
                bool match = false;
                for (int i = 0; !match && i < characterRanges.Length; i += 2)
                {
                    match = c >= characterRanges[i] && c <= characterRanges[i + 1];
                }
                if (!match && ignoreCase && (char.IsUpper(c) || char.IsLower(c)))
                {
                    var cs = c.ToString();
                    for (int i = 0; !match && i < characterRanges.Length; i += 2)
                    {
                        var min = characterRanges[i];
                        var max = characterRanges[i + 1];
                        for (char o = min; !match && o <= max; o++)
                        {
                            match = (char.IsUpper(o) || char.IsLower(o)) && cs.Equals(o.ToString(), StringComparison.CurrentCultureIgnoreCase);
                        }
                    }
                }
                if (match ^ negated)
                {
                    var endCursor = cursor.Advance(1);
                    var substr = cursor.Subject.Substring(cursor.Location, 1);
                    var result = this.ReturnHelper<string>(cursor, ref endCursor, state => substr, ruleName);
                    cursor = endCursor;
                    return result;
                }
            }
            return null;
        }

        private IParseResult<string> ParseAny(ref Cursor cursor, string ruleName = null)
        {
            if (cursor.Location + 1 <= cursor.Subject.Length)
            {
                var substr = cursor.Subject.Substring(cursor.Location, 1);
                var endCursor = cursor.Advance(1);
                var result = this.ReturnHelper<string>(cursor, ref endCursor, state => substr, ruleName);
                cursor = endCursor;
                return result;
            }
            return null;
        }

        private IParseResult<T> ReturnHelper<T>(Cursor startCursor, ref Cursor endCursor, Func<Cursor, T> wrappedCode, string ruleName = null)
        {
            if (ruleName != null)
            {
                var state = endCursor.WithMutability(true);
                var element = new LexicalElement { StartCursor = startCursor, EndCursor = endCursor, Name = ruleName };
                state["_lexical"] = (state["_lexical"] as ListNode<LexicalElement>).Push(element);
                element.EndCursor = endCursor = state.WithMutability(false);
            }
            var result = wrappedCode(endCursor);
            var lexical = result as ILexical;
            if (lexical != null && lexical.StartCursor == null && lexical.EndCursor == null)
            {
                lexical.StartCursor = startCursor;
                lexical.EndCursor = endCursor;
            }
            return new ParseResult<T>(startCursor, endCursor, result);
        }

        private Exception ExceptionHelper(Cursor cursor, Func<Cursor, string> wrappedCode)
        {
            var ex = new FormatException(wrappedCode(cursor));
            ex.Data["cursor"] = cursor;
            return ex;
        }

        private T ValueOrDefault<T>(IParseResult<T> result)
        {
            return result == null
                ? default(T)
                : result.Value;
        }
    }
}
